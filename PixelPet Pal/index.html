<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PixelPet Pal</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        body {
            font-family: 'Press Start 2P', cursive;
            margin: 0;
            overflow: hidden;
            background-color: #222;
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            text-align: center;
        }

        #game-container {
            width: 480px; /* Roughly 90s handheld screen aspect ratio */
            height: 750px; /* Increased height slightly for lang switcher */
            background-color: #f0f0f0; /* Light grey, common for old electronics */
            border-radius: 20px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5), inset 0 0 10px rgba(0,0,0,0.3);
            padding: 15px; /* Adjusted padding */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            position: relative; /* For absolute positioning of overlays */
        }

        #language-switcher {
            text-align: right;
            margin-bottom: 8px;
            font-size: 10px;
        }
        .lang-button {
            font-family: 'Press Start 2P', cursive;
            background: none;
            border: none;
            color: #0f380f;
            cursor: pointer;
            padding: 2px 5px;
            font-size: 10px;
        }
        .lang-button.active {
            background-color: #8bac0f;
            color: #0f380f;
            border-radius: 3px;
            font-weight: bold;
        }


        #screen-area {
            width: 100%;
            height: 320px; /* Main 3D view */
            background-color: #9bbc0f; /* Gameboy-esque green */
            border: 5px solid #306230;
            border-radius: 10px;
            position: relative;
            overflow: hidden; /* Ensure Three.js canvas fits */
        }

        #threejs-canvas {
            display: block; /* Remove extra space below canvas */
        }

        #info-panel {
            background-color: #cadc9f;
            border: 3px solid #8bac0f;
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px; /* Adjusted margin */
            color: #0f380f; /* Dark green text */
        }

        #info-panel h2 { /* Not used anymore, but keeping for structure if re-added */
            margin-top: 0;
            font-size: 18px;
            border-bottom: 2px solid #8bac0f;
            padding-bottom: 5px;
            margin-bottom: 10px;
        }
        
        .status-bar-container {
            margin-bottom: 8px;
        }

        .status-bar-label {
            font-size: 12px;
            margin-right: 5px;
            display: inline-block;
            width: 110px; /* Align labels - increased width for French */
            text-align: left;
        }

        .status-bar {
            display: inline-block;
            width: calc(100% - 125px); /* Adjusted for wider label */
            height: 15px;
            background-color: #8bac0f; /* Bar background */
            border: 1px solid #0f380f;
            border-radius: 3px;
            overflow: hidden;
            position: relative; /* For inner bar */
        }

        .status-bar-fill {
            height: 100%;
            background-color: #306230; /* Bar fill color */
            transition: width 0.5s ease-out;
            text-align: center;
            line-height: 15px;
            font-size: 10px;
            color: #cadc9f;
        }
        
        #pet-name-display, #pet-age-display, #pet-intelligence-display {
            font-size: 14px;
            margin-bottom: 5px;
        }

        #controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px; /* Adjusted margin */
        }

        .action-button {
            background-color: #ff69b4; /* Bright pink */
            color: white;
            border: 3px solid #c71585; /* Darker pink */
            padding: 10px 0; /* Adjusted padding */
            font-family: 'Press Start 2P', cursive;
            font-size: 12px; /* Adjusted font size */
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 3px #8b0000; /* 3D button effect */
            transition: all 0.1s ease;
            line-height: 1.2; /* For two-line text in buttons if needed */
        }

        .action-button:active {
            background-color: #c71585;
            box-shadow: 0 1px #8b0000;
            transform: translateY(2px);
        }
        
        .action-button.disabled {
            background-color: #aaa;
            color: #777;
            border-color: #888;
            box-shadow: 0 3px #555;
            cursor: not-allowed;
        }

        #message-area {
            margin-top: 10px; /* Adjusted margin */
            height: 40px;
            background-color: #444;
            color: #0f0; /* Green terminal text */
            padding: 8px;
            border-radius: 5px;
            font-size: 12px;
            overflow-y: auto; /* For multiple messages if needed */
            text-align: left;
            line-height: 1.4;
        }

        /* Overlay for start/game over screens */
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            padding: 20px;
            box-sizing: border-box;
        }

        .overlay h1 {
            color: #ff69b4;
            margin-bottom: 20px;
        }
        .overlay p {
            margin-bottom: 20px;
            line-height: 1.5;
        }
        .overlay input[type="text"] {
            font-family: 'Press Start 2P', cursive;
            padding: 10px;
            margin-bottom: 20px;
            border: 2px solid #ff69b4;
            background-color: #333;
            color: #fff;
            font-size: 16px;
            text-align: center;
        }
        .overlay button {
            background-color: #00ff00; /* Bright green */
            color: #0f380f;
            border: 3px solid #00aa00; /* Darker green */
            padding: 15px 30px;
            font-family: 'Press Start 2P', cursive;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 3px #006400;
        }
         .overlay button:active {
            background-color: #00aa00;
            box-shadow: 0 1px #006400;
            transform: translateY(2px);
        }

        #fact-bubble {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(255, 255, 255, 0.9);
            color: #0f380f;
            padding: 10px 15px;
            border-radius: 10px;
            border: 2px solid #8bac0f;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            font-size: 11px;
            max-width: 80%;
            text-align: center;
            z-index: 50;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            pointer-events: none;
        }
        #fact-bubble.visible {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="language-switcher">
            <button id="lang-en" class="lang-button">EN</button> |
            <button id="lang-fr" class="lang-button">FR</button>
        </div>

        <div id="start-screen" class="overlay">
            <h1 data-translate-key="appName">PixelPet Pal!</h1>
            <p data-translate-key="nameYourPet">Name your new digital friend:</p>
            <input type="text" id="pet-name-input" maxlength="10" value="PixelPuff">
            <button id="start-button" data-translate-key="hatchPet">Hatch Pet!</button>
            <p style="font-size:10px; margin-top: 30px;" data-translate-key="careInstructions">Care for your pet by feeding it, playing, cleaning, and helping it learn. Don't let its needs drop too low!</p>
        </div>

        <div id="game-over-screen" class="overlay" style="display: none;">
            <h1 data-translate-key="gameOverTitle">Game Over!</h1>
            <p id="game-over-message">Your PixelPet got sad and ran away...</p>
            <p><span data-translate-key="gameOverLivedForPrefix">It lived for </span><span id="final-age">0</span><span data-translate-key="gameOverLivedForSuffix"> days.</span></p>
            <button id="restart-button" data-translate-key="playAgain">Play Again?</button>
        </div>
        
        <div id="screen-area">
            <div id="threejs-canvas"></div>
            <div id="fact-bubble"></div>
        </div>

        <div id="info-panel">
            <div id="pet-name-display">Name: PixelPuff</div>
            <div id="pet-age-display">Age: 0 days</div>
            <div id="pet-intelligence-display">Intelligence: 0</div>
            
            <div class="status-bar-container">
                <span class="status-bar-label" data-translate-key="labelHunger">Hunger:</span>
                <div class="status-bar"><div id="hunger-bar" class="status-bar-fill" style="width: 100%;">100%</div></div>
            </div>
            <div class="status-bar-container">
                <span class="status-bar-label" data-translate-key="labelHappiness">Happiness:</span>
                <div class="status-bar"><div id="happiness-bar" class="status-bar-fill" style="width: 100%;">100%</div></div>
            </div>
            <div class="status-bar-container">
                <span class="status-bar-label" data-translate-key="labelCleanliness">Cleanliness:</span>
                <div class="status-bar"><div id="cleanliness-bar" class="status-bar-fill" style="width: 100%;">100%</div></div>
            </div>
        </div>

        <div id="controls">
            <button id="feed-button" class="action-button" data-translate-key="btnFeed">Feed üçé</button>
            <button id="play-button" class="action-button" data-translate-key="btnPlay">Play üéæ</button>
            <button id="clean-button" class="action-button" data-translate-key="btnClean">Clean ‚ú®</button>
            <button id="learn-button" class="action-button" data-translate-key="btnLearn">Learn üß†</button>
            <button id="lights-button" class="action-button">Lights üí°</button> <!-- Dynamic text -->
            <button id="info-button" class="action-button" data-translate-key="btnInfo">Info ‚ùì</button>
        </div>
        <div id="message-area">Welcome to PixelPet Pal!</div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        // --- Localization ---
        const translations = {
            en: {
                appName: "PixelPet Pal!",
                nameYourPet: "Name your new digital friend:",
                hatchPet: "Hatch Pet!",
                careInstructions: "Care for your pet by feeding it, playing, cleaning, and helping it learn. Don't let its needs drop too low!",
                gameOverTitle: "Game Over!",
                gameOverDefault: "Your PixelPet got sad and ran away...",
                gameOverLivedForPrefix: "It lived for ",
                gameOverLivedForSuffix: " days.",
                playAgain: "Play Again?",
                labelName: "Name:",
                labelAge: "Age:",
                labelDays: "days",
                labelIntelligence: "Intelligence:",
                labelHunger: "Hunger:",
                labelHappiness: "Happiness:",
                labelCleanliness: "Cleanliness:",
                btnFeed: "Feed üçé",
                btnPlay: "Play üéæ",
                btnClean: "Clean ‚ú®",
                btnLearn: "Learn üß†",
                btnLightsOn: "Lights üí°",
                btnLightsOff: "Lights ‚òÄÔ∏è",
                btnInfo: "Info ‚ùì",
                welcomeMessage: "Welcome to PixelPet Pal!",
                alertEnterPetName: "Please enter a name for your pet!",
                petHatched: "{petName} has hatched! Welcome!",
                petAgeUp: "{petName} is now {age} day(s) old!",
                petAte: "{petName} enjoyed a tasty snack! Yum!",
                petNotHungry: "{petName} is not hungry right now.",
                petPlayed: "{petName} had fun playing! Whee!",
                petWantsRest: "{petName} wants to rest a bit.",
                petCleaned: "{petName} is sparkling clean!",
                petAlreadyClean: "{petName} is already very clean.",
                petLearned: "{petName} learned something new!",
                petGenius: "{petName} is a genius already!",
                petSleeping: "{petName} is going to sleep... Zzz...",
                petWokeUp: "{petName} woke up!",
                infoText: "PixelPet Pal v1.0. Care for your pet! Made with ‚ù§Ô∏è by ParisNeo.",
                gameOverOverwhelmed: "{petName} became overwhelmed and left...",
                gameOverHungry: "{petName} got too hungry and fainted!",
                gameOverSad: "{petName} became too sad and ran away...",
                gameOverDirty: "{petName} got too dirty and feels sick.",
                gameOverLived: "Game Over. {petName} lived for {age} days.",
                petMadeMess: "{petName} made a mess!",
                petUnwell: "{petName} is feeling really unwell! Clean up soon!",
                facts: [
                    "A group of flamingos is called a flamboyance!", "The heart of a shrimp is in its head!", "Slugs have four noses!", "Butterflies taste with their feet!", "A snail can sleep for three years!", "Elephants can't jump!", "The moon has moonquakes.", "Polar bears have black skin."
                ]
            },
            fr: {
                appName: "PixelCompagnon !",
                nameYourPet: "Nommez votre nouvel ami digital :",
                hatchPet: "Faire √©clore !",
                careInstructions: "Prenez soin de votre animal : nourrissez-le, jouez, nettoyez et aidez-le √† apprendre. Ne laissez pas ses besoins chuter !",
                gameOverTitle: "Partie Termin√©e !",
                gameOverDefault: "Votre PixelCompagnon est devenu triste et s'est enfui...",
                gameOverLivedForPrefix: "Il a v√©cu ",
                gameOverLivedForSuffix: " jours.",
                playAgain: "Rejouer ?",
                labelName: "Nom :",
                labelAge: "√Çge :",
                labelDays: "jours",
                labelIntelligence: "Intelligence :",
                labelHunger: "Faim :",
                labelHappiness: "Bonheur :",
                labelCleanliness: "Propret√© :",
                btnFeed: "Nourrir üçé",
                btnPlay: "Jouer üéæ",
                btnClean: "Nettoyer ‚ú®",
                btnLearn: "Apprendre üß†",
                btnLightsOn: "Lumi√®re üí°",
                btnLightsOff: "Lumi√®re ‚òÄÔ∏è",
                btnInfo: "Infos ‚ùì",
                welcomeMessage: "Bienvenue √† PixelCompagnon !",
                alertEnterPetName: "Veuillez donner un nom √† votre animal !",
                petHatched: "{petName} est n√© ! Bienvenue !",
                petAgeUp: "{petName} a maintenant {age} jour(s) !",
                petAte: "{petName} a d√©gust√© un bon repas ! Miam !",
                petNotHungry: "{petName} n'a pas faim pour l'instant.",
                petPlayed: "{petName} s'est bien amus√© ! Youpi !",
                petWantsRest: "{petName} veut se reposer un peu.",
                petCleaned: "{petName} est tout propre !",
                petAlreadyClean: "{petName} est d√©j√† tr√®s propre.",
                petLearned: "{petName} a appris quelque chose de nouveau !",
                petGenius: "{petName} est d√©j√† un g√©nie !",
                petSleeping: "{petName} va dormir... Zzz...",
                petWokeUp: "{petName} s'est r√©veill√© !",
                infoText: "PixelCompagnon v1.0. Prenez soin de votre animal ! Fait avec ‚ù§Ô∏è par ParisNeo.",
                gameOverOverwhelmed: "{petName} est parti, se sentant d√©pass√©...",
                gameOverHungry: "{petName} avait trop faim et s'est √©vanoui !",
                gameOverSad: "{petName} √©tait trop triste et s'est enfui...",
                gameOverDirty: "{petName} est devenu trop sale et se sent mal.",
                gameOverLived: "Partie termin√©e. {petName} a v√©cu {age} jours.",
                petMadeMess: "{petName} a fait des salet√©s !",
                petUnwell: "{petName} se sent vraiment mal ! Nettoyez vite !",
                facts: [
                    "Un groupe de flamants roses s'appelle une flamboyance !", "Le c≈ìur d'une crevette est dans sa t√™te !", "Les limaces ont quatre nez !", "Les papillons go√ªtent avec leurs pieds !", "Un escargot peut dormir trois ans !", "Les √©l√©phants ne peuvent pas sauter !", "La lune a des tremblements de lune.", "Les ours polaires ont la peau noire."
                ]
            }
        };
        let currentLanguage = localStorage.getItem('pixelPetLang') || 'en';
        let currentEducationalFacts = translations[currentLanguage].facts;
        let lastGameOverMessageKey = 'gameOverDefault'; // To store the key for re-translation

        function translate(key, params = {}) {
            let text = translations[currentLanguage]?.[key] || translations.en[key] || key;
            for (const param in params) {
                text = text.replace(new RegExp(`{${param}}`, 'g'), params[param]);
            }
            return text;
        }

        function applyTranslations() {
            document.querySelectorAll('[data-translate-key]').forEach(el => {
                const key = el.getAttribute('data-translate-key');
                el.textContent = translate(key);
            });
            
            // Dynamic button texts
            lightsButton.textContent = isSleeping ? translate('btnLightsOff') : translate('btnLightsOn');
            
            // Info panel specific updates
            petNameDisplay.textContent = `${translate('labelName')} ${petName}`;
            petAgeDisplay.textContent = `${translate('labelAge')} ${age} ${translate('labelDays')}`;
            petIntelligenceDisplay.textContent = `${translate('labelIntelligence')} ${intelligence}`;

            // Initial message
            if (!gameLoopInterval && messageArea.firstChild?.textContent.startsWith('> Welcome')) { // Check if initial message is there
                 messageArea.innerHTML = ''; // Clear previous
                 addMessage(translate('welcomeMessage'));
            }

            // Game Over screen (if visible)
            if (gameOverScreen.style.display === 'flex') {
                gameOverMessage.textContent = translate(lastGameOverMessageKey, { petName: petName });
            }
            // Update active language button
            document.querySelectorAll('.lang-button').forEach(btn => btn.classList.remove('active'));
            const activeBtn = document.getElementById(`lang-${currentLanguage}`);
            if(activeBtn) activeBtn.classList.add('active');
        }

        function setLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('pixelPetLang', lang);
            currentEducationalFacts = translations[currentLanguage].facts || translations.en.facts;
            applyTranslations();
            updateUI(); // Refresh status bars as their labels might have changed
        }


        // --- Game Constants ---
        const MAX_STAT = 100;
        const STAT_DECREASE_INTERVAL = 3000; // ms
        const HUNGER_DECREASE = 3;
        const HAPPINESS_DECREASE = 2;
        const CLEANLINESS_DECREASE_BASE = 1;
        const POOP_CHANCE = 0.1;
        const POOP_CLEANLINESS_PENALTY = 10;
        const MAX_POOPS = 5;
        const AGE_INTERVAL = 60000; // 1 minute
        const ACTION_COOLDOWN = 2000; // 2 seconds

        // --- Three.js Variables ---
        let scene, camera, renderer, petMesh, ambientLight, directionalLight;
        let eyeLeft, eyeRight, mouth;
        let poopMeshes = [];
        let isSleeping = false;
        let originalPetColor = 0x00ff00;

        // --- Game State Variables ---
        let petName = "PixelPuff";
        let hunger = MAX_STAT;
        let happiness = MAX_STAT;
        let cleanliness = MAX_STAT;
        let intelligence = 0;
        let age = 0;
        let gameLoopInterval, ageInterval;
        let isGameOver = false;
        let actionInProgress = false;

        // --- DOM Elements ---
        const screenArea = document.getElementById('screen-area');
        const threeJsCanvasContainer = document.getElementById('threejs-canvas');
        const hungerBar = document.getElementById('hunger-bar');
        const happinessBar = document.getElementById('happiness-bar');
        const cleanlinessBar = document.getElementById('cleanliness-bar');
        const petNameDisplay = document.getElementById('pet-name-display');
        const petAgeDisplay = document.getElementById('pet-age-display');
        const petIntelligenceDisplay = document.getElementById('pet-intelligence-display');
        const messageArea = document.getElementById('message-area');
        
        const feedButton = document.getElementById('feed-button');
        const playButton = document.getElementById('play-button');
        const cleanButton = document.getElementById('clean-button');
        const learnButton = document.getElementById('learn-button');
        const lightsButton = document.getElementById('lights-button');
        const infoButton = document.getElementById('info-button');
        
        const startScreen = document.getElementById('start-screen');
        const gameOverScreen = document.getElementById('game-over-screen');
        const petNameInput = document.getElementById('pet-name-input');
        const startButton = document.getElementById('start-button');
        const restartButton = document.getElementById('restart-button');
        const finalAgeDisplay = document.getElementById('final-age');
        const gameOverMessage = document.getElementById('game-over-message');
        const factBubble = document.getElementById('fact-bubble');
        const langEnButton = document.getElementById('lang-en');
        const langFrButton = document.getElementById('lang-fr');


        // --- Initialization ---
        function initThree() {
            scene = new THREE.Scene();
            const aspectRatio = screenArea.clientWidth / screenArea.clientHeight;
            camera = new THREE.PerspectiveCamera(75, aspectRatio, 0.1, 1000);
            camera.position.z = 5;

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(screenArea.clientWidth, screenArea.clientHeight);
            renderer.setClearColor(0x000000, 0);
            threeJsCanvasContainer.appendChild(renderer.domElement);

            ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(5, 10, 7.5);
            scene.add(directionalLight);

            const bodyGeometry = new THREE.SphereGeometry(1, 32, 32);
            const bodyMaterial = new THREE.MeshStandardMaterial({ color: originalPetColor, roughness: 0.5, metalness: 0.1 });
            petMesh = new THREE.Mesh(bodyGeometry, bodyMaterial);
            petMesh.position.y = -0.2;
            scene.add(petMesh);

            const eyeGeometry = new THREE.SphereGeometry(0.15, 16, 16);
            const eyeMaterial = new THREE.MeshBasicMaterial({ color: 0x000000 });
            
            eyeLeft = new THREE.Mesh(eyeGeometry, eyeMaterial);
            eyeLeft.position.set(-0.35, 0.2, 0.85);
            petMesh.add(eyeLeft);

            eyeRight = new THREE.Mesh(eyeGeometry, eyeMaterial);
            eyeRight.position.set(0.35, 0.2, 0.85);
            petMesh.add(eyeRight);

            const mouthGeometry = new THREE.PlaneGeometry(0.4, 0.1);
            const mouthMaterial = new THREE.MeshBasicMaterial({ color: 0x000000, side: THREE.DoubleSide });
            mouth = new THREE.Mesh(mouthGeometry, mouthMaterial);
            mouth.position.set(0, -0.2, 0.9);
            petMesh.add(mouth);
        }

        function initGame() {
            isGameOver = false;
            actionInProgress = false;
            isSleeping = false;
            petName = petNameInput.value || "PixelPuff";
            hunger = MAX_STAT;
            happiness = MAX_STAT;
            cleanliness = MAX_STAT;
            intelligence = 0;
            age = 0;

            clearPoops();
            
            petNameDisplay.textContent = `${translate('labelName')} ${petName}`; // Update with name
            updateUI();
            updatePetVisuals();
            addMessage(translate('petHatched', {petName: petName}));


            if (gameLoopInterval) clearInterval(gameLoopInterval);
            gameLoopInterval = setInterval(gameTick, STAT_DECREASE_INTERVAL);
            
            if (ageInterval) clearInterval(ageInterval);
            ageInterval = setInterval(increaseAge, AGE_INTERVAL);

            startScreen.style.display = 'none';
            gameOverScreen.style.display = 'none';
            enableButtons();
            applyTranslations(); // Ensure all texts are correct after game start
        }
        
        // --- Game Loop & Logic ---
        function gameTick() {
            if (isGameOver || isSleeping) return;

            hunger = Math.max(0, hunger - HUNGER_DECREASE);
            happiness = Math.max(0, happiness - HAPPINESS_DECREASE);
            
            let cleanlinessDecrease = CLEANLINESS_DECREASE_BASE;
            if (Math.random() < POOP_CHANCE && poopMeshes.length < MAX_POOPS) {
                addPoop();
                cleanlinessDecrease += POOP_CLEANLINESS_PENALTY / 5;
                addMessage(translate('petMadeMess', {petName: petName}));
            }
            cleanliness = Math.max(0, cleanliness - cleanlinessDecrease - (poopMeshes.length * 2));

            if (hunger < 20) happiness = Math.max(0, happiness - 3);
            if (cleanliness < 20) happiness = Math.max(0, happiness - 3);

            updateUI();
            updatePetVisuals();
            checkGameOver();
        }

        function increaseAge() {
            if (isGameOver || isSleeping) return;
            age++;
            updateUI();
            addMessage(translate('petAgeUp', {petName: petName, age: age}));
            if (age % 5 === 0 && intelligence > 0) {
                showRandomFact();
            }
        }

        function checkGameOver() {
            let reasonKey = null;
            if (hunger === 0 && happiness === 0 && cleanliness === 0) {
                reasonKey = 'gameOverOverwhelmed';
            } else if (hunger === 0) {
                reasonKey = 'gameOverHungry';
            } else if (happiness === 0) {
                reasonKey = 'gameOverSad';
            } else if (cleanliness === 0) {
                 addMessage(translate('petUnwell', {petName: petName}), 'error');
                 happiness = Math.max(0, happiness - 10);
            }
            
            if (reasonKey) {
                lastGameOverMessageKey = reasonKey; // Store key for potential re-translation
                gameOverMessage.textContent = translate(reasonKey, {petName: petName});
                endGame();
            }
        }

        function endGame() {
            isGameOver = true;
            clearInterval(gameLoopInterval);
            clearInterval(ageInterval);
            finalAgeDisplay.textContent = age;
            // The gameOverMessage is set in checkGameOver
            gameOverScreen.style.display = 'flex';
            addMessage(translate('gameOverLived', {petName: petName, age: age}));
            disableButtons();
            applyTranslations(); // Ensure game over screen is translated
        }

        // --- Player Actions ---
        function handleAction(actionFn) { // Removed cost, success, penalty from params, handled in actionFn
            if (isGameOver || actionInProgress || isSleeping) return;
            
            actionInProgress = true;
            disableButtons();
            setTimeout(() => {
                actionInProgress = false;
                if (!isGameOver && !isSleeping) enableButtons();
            }, ACTION_COOLDOWN);

            actionFn();
            updateUI();
            updatePetVisuals();
        }

        function feedPet() {
            handleAction(() => {
                if (hunger < MAX_STAT) {
                    hunger = Math.min(MAX_STAT, hunger + 25);
                    happiness = Math.min(MAX_STAT, happiness + 5);
                    addMessage(translate('petAte', {petName: petName}));
                    animatePetInteraction('feed');
                } else {
                    addMessage(translate('petNotHungry', {petName: petName}));
                    happiness = Math.max(0, happiness - 5);
                }
            });
        }

        function playWithPet() {
            handleAction(() => {
                if (happiness < MAX_STAT) {
                    happiness = Math.min(MAX_STAT, happiness + 20);
                    hunger = Math.max(0, hunger - 5);
                    addMessage(translate('petPlayed', {petName: petName}));
                    animatePetInteraction('play');
                } else {
                    addMessage(translate('petWantsRest', {petName: petName}));
                }
            });
        }

        function cleanPet() {
             handleAction(() => {
                if (cleanliness < MAX_STAT || poopMeshes.length > 0) {
                    cleanliness = Math.min(MAX_STAT, cleanliness + 30 + (poopMeshes.length * 10) );
                    clearPoops();
                    addMessage(translate('petCleaned', {petName: petName}));
                    animatePetInteraction('clean');
                } else {
                    addMessage(translate('petAlreadyClean', {petName: petName}));
                }
            });
        }
        
        function learnWithPet() {
            handleAction(() => {
                if (intelligence < 100) {
                    intelligence += 5;
                    happiness = Math.min(MAX_STAT, happiness + 10);
                    hunger = Math.max(0, hunger - 3);
                    addMessage(translate('petLearned', {petName: petName}));
                    animatePetInteraction('learn');
                    showRandomFact(true);
                } else {
                    addMessage(translate('petGenius', {petName: petName}));
                }
                petIntelligenceDisplay.textContent = `${translate('labelIntelligence')} ${intelligence}`;
            });
        }

        function toggleLights() {
            if (isGameOver) return;
            isSleeping = !isSleeping;
            if (isSleeping) {
                addMessage(translate('petSleeping', {petName: petName}));
                ambientLight.intensity = 0.1;
                directionalLight.intensity = 0.1;
                lightsButton.textContent = translate('btnLightsOff');
                disableButtons(true);
            } else {
                addMessage(translate('petWokeUp', {petName: petName}));
                ambientLight.intensity = 0.6;
                directionalLight.intensity = 0.8;
                lightsButton.textContent = translate('btnLightsOn');
                enableButtons();
                if (hunger < 50) happiness = Math.max(0, happiness - 10);
            }
            updatePetVisuals();
        }

        function showInfo() {
            addMessage(translate('infoText'));
        }
        
        function showRandomFact(forceShow = false) {
            if (isSleeping || isGameOver || currentEducationalFacts.length === 0) return;
            if (forceShow || (Math.random() < 0.3 && intelligence > 10)) {
                const fact = currentEducationalFacts[Math.floor(Math.random() * currentEducationalFacts.length)];
                factBubble.textContent = fact; // Facts are already translated strings
                factBubble.classList.add('visible');
                setTimeout(() => {
                    factBubble.classList.remove('visible');
                }, 5000);
            }
        }

        // --- UI Updates ---
        function updateUI() {
            hungerBar.style.width = `${hunger}%`;
            hungerBar.textContent = `${Math.round(hunger)}%`;
            happinessBar.style.width = `${happiness}%`;
            happinessBar.textContent = `${Math.round(happiness)}%`;
            cleanlinessBar.style.width = `${cleanliness}%`;
            cleanlinessBar.textContent = `${Math.round(cleanliness)}%`;
            
            petAgeDisplay.textContent = `${translate('labelAge')} ${age} ${translate('labelDays')}`;
            petIntelligenceDisplay.textContent = `${translate('labelIntelligence')} ${intelligence}`;
            petNameDisplay.textContent = `${translate('labelName')} ${petName}`;


            [hungerBar, happinessBar, cleanlinessBar].forEach(bar => {
                const value = parseInt(bar.style.width);
                if (value < 25) bar.style.backgroundColor = '#d9534f';
                else if (value < 60) bar.style.backgroundColor = '#f0ad4e';
                else bar.style.backgroundColor = '#306230';
            });
             // Ensure button text is correct, especially for Lights button after UI updates
            lightsButton.textContent = isSleeping ? translate('btnLightsOff') : translate('btnLightsOn');
        }

        function addMessage(text, type = 'info') {
            const maxMessages = 3;
            const messageP = document.createElement('p');
            messageP.textContent = `> ${text}`;
            if (type === 'error') messageP.style.color = '#ff4444';
            
            messageArea.appendChild(messageP);
            while (messageArea.childElementCount > maxMessages) {
                messageArea.removeChild(messageArea.firstChild);
            }
            messageArea.scrollTop = messageArea.scrollHeight;
        }

        function enableButtons() {
            feedButton.classList.remove('disabled');
            playButton.classList.remove('disabled');
            cleanButton.classList.remove('disabled');
            learnButton.classList.remove('disabled');
            infoButton.classList.remove('disabled');
            lightsButton.classList.remove('disabled');
        }

        function disableButtons(isSleepingOverride = false) {
            feedButton.classList.add('disabled');
            playButton.classList.add('disabled');
            cleanButton.classList.add('disabled');
            learnButton.classList.add('disabled');
            infoButton.classList.add('disabled');
            if (!isSleepingOverride) {
                lightsButton.classList.add('disabled');
            }
        }

        // --- Pet Visuals & Animations (No changes needed for localization) ---
        function updatePetVisuals() {
            if (!petMesh) return;
            if (isSleeping) {
                eyeLeft.scale.set(1, 0.1, 1); eyeRight.scale.set(1, 0.1, 1);
                mouth.scale.set(1, 0.1, 1); petMesh.material.color.set(0x5555cc);
                return;
            } else {
                eyeLeft.scale.set(1, 1, 1); eyeRight.scale.set(1, 1, 1);
                mouth.scale.set(1, 1, 1); petMesh.material.color.set(originalPetColor);
            }
            if (happiness < 30 || hunger < 30) {
                petMesh.material.color.set(0xffa500);
                eyeLeft.scale.y = 0.7; eyeLeft.position.y = 0.15;
                eyeRight.scale.y = 0.7; eyeRight.position.y = 0.15;
                mouth.rotation.z = Math.PI / 12;
            } else if (happiness > 80) {
                petMesh.material.color.set(0x00ff00);
                eyeLeft.scale.y = 1.2; eyeLeft.position.y = 0.25;
                eyeRight.scale.y = 1.2; eyeRight.position.y = 0.25;
                mouth.rotation.z = -Math.PI / 16;
            } else {
                petMesh.material.color.set(originalPetColor);
                eyeLeft.scale.y = 1; eyeLeft.position.y = 0.2;
                eyeRight.scale.y = 1; eyeRight.position.y = 0.2;
                mouth.rotation.z = 0;
            }
            if (cleanliness < 40) {
                const dirtColor = new THREE.Color(0x8B4513);
                petMesh.material.color.lerp(dirtColor, (40 - cleanliness) / 40 * 0.6);
            }
        }
        function animatePetInteraction(type) {
            if (isSleeping) return;
            let originalY = petMesh.position.y;
            if (type === 'feed' || type === 'learn') {
                petMesh.position.y += 0.2;
                setTimeout(() => { petMesh.position.y = originalY - 0.1;}, 100);
                setTimeout(() => { petMesh.position.y = originalY;}, 200);
            } else if (type === 'play') {
                petMesh.position.y += 0.5; petMesh.rotation.y += Math.PI / 4;
                setTimeout(() => { petMesh.position.y = originalY; petMesh.rotation.y -= Math.PI / 2; }, 150);
                setTimeout(() => { petMesh.rotation.y += Math.PI / 4; }, 300);
            } else if (type === 'clean') {
                petMesh.rotation.z = 0.2;
                setTimeout(() => { petMesh.rotation.z = -0.2;}, 100);
                setTimeout(() => { petMesh.rotation.z = 0.2;}, 200);
                setTimeout(() => { petMesh.rotation.z = 0;}, 300);
            }
        }
        function addPoop() {
            if (poopMeshes.length >= MAX_POOPS) return;
            const poopGeometry = new THREE.SphereGeometry(0.2, 8, 8);
            poopGeometry.scale(1, 0.6, 1);
            const poopMaterial = new THREE.MeshStandardMaterial({ color: 0x5C3317, roughness: 0.8 });
            const poop = new THREE.Mesh(poopGeometry, poopMaterial);
            const angle = Math.random() * Math.PI * 2;
            const radius = 1.5 + Math.random() * 0.5;
            poop.position.set(Math.cos(angle) * radius, -0.9, Math.sin(angle) * radius -0.5);
            scene.add(poop);
            poopMeshes.push(poop);
        }
        function clearPoops() {
            poopMeshes.forEach(p => scene.remove(p));
            poopMeshes = [];
        }

        // --- Animation Loop ---
        function animate() {
            if (isGameOver && gameOverScreen.style.display === 'none') return;
            requestAnimationFrame(animate);
            if (petMesh && !isSleeping) {
                const time = Date.now() * 0.0015;
                petMesh.position.y = -0.2 + Math.sin(time) * 0.05;
            } else if (petMesh && isSleeping) {
                 petMesh.position.y = -0.2;
            }
            renderer.render(scene, camera);
        }
        
        // --- Event Listeners ---
        startButton.addEventListener('click', () => {
            petName = petNameInput.value.trim();
            if (!petName) {
                alert(translate('alertEnterPetName'));
                return;
            }
            initGame();
        });
        restartButton.addEventListener('click', () => {
            startScreen.style.display = 'flex';
            gameOverScreen.style.display = 'none';
            applyTranslations(); // Ensure start screen is translated
        });

        feedButton.addEventListener('click', feedPet);
        playButton.addEventListener('click', playWithPet);
        cleanButton.addEventListener('click', cleanPet);
        learnButton.addEventListener('click', learnWithPet);
        lightsButton.addEventListener('click', toggleLights);
        infoButton.addEventListener('click', showInfo);

        langEnButton.addEventListener('click', () => setLanguage('en'));
        langFrButton.addEventListener('click', () => setLanguage('fr'));

        window.addEventListener('resize', () => {
            if (screenArea.clientWidth > 0 && screenArea.clientHeight > 0) {
                camera.aspect = screenArea.clientWidth / screenArea.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(screenArea.clientWidth, screenArea.clientHeight);
            }
        }, false);


        // --- Start Up ---
        initThree();
        animate(); 
        setLanguage(currentLanguage); // Apply initial language settings
        
    </script>
</body>
</html>